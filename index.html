<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkyGuardian Agri-Intelligence</title>
    <style>
        :root { --agri-green: #27ae60; --bg: #f0f4f1; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: auto; }
        
        .header { background: white; padding: 20px; border-radius: 15px; text-align: center; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        h1 { color: var(--agri-green); margin: 0; }
        
        .status-container { display: flex; align-items: center; justify-content: center; margin-top: 10px; font-weight: bold; }
        .status-dot { width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; background: #95a5a6; transition: 0.3s; }
        
        /* CENTERED GAUGE GRID */
        /* Update your CSS with this exact block */
        /* Update these specific classes in your <style> tag */
        .grid { 
            display: flex; 
            flex-flow: row nowrap;    /* Prevents the third gauge from dropping down */
            justify-content: center;  /* Centers the entire group */
            align-items: stretch;     /* Makes all cards the same height */
            gap: 10px;                /* Tightens the space to fit all three */
            width: 100%;
            margin: 20px auto;
        }
        
        .card { 
            background: white; 
            padding: 10px;            /* Reduced padding to save space */
            border-radius: 15px; 
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); 
            flex: 1 1 300px;          /* Allows cards to grow and shrink equally */
            max-width: 33%;           /* Ensures they take up exactly 1/3 of the row */
        }
        
        /* Mobile Responsive: Stack them only when the screen is very small */
        @media (max-width: 900px) {
            .grid { flex-wrap: wrap; }
            .card { max-width: 100%; flex: 1 1 100%; }
        }
        
        .analysis-box { background: white; border-left: 10px solid var(--agri-green); padding: 20px; border-radius: 10px; margin-bottom: 30px; }
        iframe { border: none; width: 100%; height: 260px; border-radius: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>SkyGuardian | Agricultural Node</h1>
        <div class="status-container">
            <div id="status-dot" class="status-dot"></div>
            <span id="status-text">Connecting to Field Node...</span>
        </div>
    </div>

    <div class="analysis-box">
        <h3>üöú Agricultural Insight</h3>
        <p id="insight-text" style="font-size: 1.1em;">Monitoring live conditions...</p>
    </div>

    <div class="grid">
        <div class="card"><h3>Ambient Temperature</h3><iframe src="https://thingspeak.com/channels/3231323/widgets/1206428"></iframe></div>
        <div class="card"><h3>Canopy Humidity</h3><iframe src="https://thingspeak.com/channels/3231323/widgets/1206435"></iframe></div>
        <div class="card"><h3>Atmospheric Pressure</h3><iframe src="https://thingspeak.com/channels/3231323/widgets/1206436"></iframe></div>
    </div>

    <div class="card" style="width: 100%; box-sizing: border-box;">
        <h3>24-Hour Environmental Trends</h3>
        <iframe src="https://thingspeak.com/channels/3231323/charts/1?dynamic=true&results=60&color=27ae60"></iframe>
    </div>
</div>

<script>
    async function fetchAgriData() {
        const chanID = '3231323';
        const apiKey = 'PXZJ8EKXDGBQM64P'; 
        const url = `https://api.thingspeak.com/channels/${chanID}/feeds/last.json?api_key=${apiKey}`;

        try {
            const response = await fetch(url);
            const data = await response.json();
            
            if(!data.created_at) return;

            const lastSync = new Date(data.created_at);
            const now = new Date();
            const diffSec = Math.floor((now - lastSync) / 1000);
            
            const dot = document.getElementById('status-dot');
            const statusLabel = document.getElementById('status-text');

            // FIX FOR NaNm: Ensure diffSec is a number
            if (!isNaN(diffSec) && diffSec < 60) {
                dot.style.background = "#2ecc71";
                statusLabel.innerText = "Field Node: Online (Live)";
            } else {
                dot.style.background = "#e74c3c";
                const mins = Math.max(0, Math.floor(diffSec / 60));
                statusLabel.innerText = `Field Node: Offline (${mins}m ago)`;
            }

            // INSIGHT LOGIC
            const T = parseFloat(data.field1);
            let msg = T > 20 ? "‚úÖ OPTIMAL: Temperatures are ideal for crop development." : "‚ö†Ô∏è COOL: Growth may slow down.";
            document.getElementById('insight-text').innerText = msg;

        } catch (e) { console.error("API Link Broken"); }
    }
    fetchAgriData();
    setInterval(fetchAgriData, 15000); // 15-second refresh for real-time feel
</script>
</body>
</html>


